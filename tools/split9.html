<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Image Splitter - 連続ダウンロード</title>
<style>
  #preview {
    display: grid;
    gap: 5px;
    margin-top: 10px;
  }
  .piece { width: 70px; height: 70px; border: 1px solid #aaa; }
  #downloadAll { margin-top: 10px; padding: 5px 10px; }
</style>
</head>
<body>

<h3>画像を選択してください（分割数 9）</h3>
<input type="file" id="file">
<button id="downloadAll">連続ダウンロード</button>
<div id="preview"></div>

<script>
let size = 3; // 3x3, 4x4, 5x5 に変更可能
const pieces = [];

document.getElementById("file").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = () => splitImage(img);
});

function splitImage(img) {
  const preview = document.getElementById("preview");
  preview.innerHTML = "";
  pieces.length = 0;

  // CSSで列数を自動調整
  preview.style.gridTemplateColumns = `repeat(${size}, 70px)`;

  const pieceSize = Math.floor(Math.min(img.width, img.height) / size);

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const canvas = document.createElement("canvas");
      canvas.width = pieceSize;
      canvas.height = pieceSize;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(
        img,
        x * pieceSize, y * pieceSize, pieceSize, pieceSize,
        0, 0, pieceSize, pieceSize
      );

      canvas.className = "piece";
      preview.appendChild(canvas);
      pieces.push({canvas: canvas, name: `piece_${y*size + x}.jpg`});
    }
  }
}

// 連続ダウンロード
document.getElementById("downloadAll").addEventListener("click", async () => {
  if(pieces.length === 0) return alert("先に画像を選択してください");

  for (const p of pieces) {
    await new Promise(resolve => {
      p.canvas.toBlob(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = p.name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        resolve();
      }, "image/jpeg");
    });
    // 連続クリックが早すぎると反応しない場合があるので少し待つ
    await new Promise(r => setTimeout(r, 50));
  }
});
</script>

</body>
</html>
